name: Intermediate Production-Grade CI/CD

on:
  push:
    branches: [main, develop, staging, preprod]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - pre-production
        - production
      enable_sonar:
        description: 'Enable SonarCloud analysis'
        type: boolean
        default: true
      enable_checkmarx:
        description: 'Enable Checkmarx security scanning'
        type: boolean
        default: true
      force_version:
        description: 'Override version (production only)'
        required: false
        type: string

env:
  NODE_VERSION: '18'
  
  # Security scanning controls
  ENABLE_SONAR: ${{ github.event.inputs.enable_sonar || vars.ENABLE_SONAR_SCAN || 'true' }}
  ENABLE_CHECKMARX: ${{ github.event.inputs.enable_checkmarx || vars.ENABLE_CHECKMARX_SCAN || 'true' }}
  
  # Quality gate thresholds
  MIN_CODE_COVERAGE: ${{ vars.MIN_CODE_COVERAGE || '80' }}
  MAX_CRITICAL_VULNERABILITIES: ${{ vars.MAX_CRITICAL_VULNERABILITIES || '0' }}
  MAX_HIGH_VULNERABILITIES: ${{ vars.MAX_HIGH_VULNERABILITIES || '2' }}

permissions:
  contents: read
  id-token: write
  actions: read
  security-events: write
  pull-requests: write

jobs:
  # Production-grade deployment detection with all your requested features
  detect-deployment:
    name: ğŸ” Deployment Strategy Detection
    runs-on: ubuntu-latest
    outputs:
      deploy-dev: ${{ steps.strategy.outputs.deploy-dev }}
      deploy-staging: ${{ steps.strategy.outputs.deploy-staging }}
      deploy-preprod: ${{ steps.strategy.outputs.deploy-preprod }}
      deploy-prod: ${{ steps.strategy.outputs.deploy-prod }}
      dev-version: ${{ steps.versions.outputs.dev-version }}
      staging-version: ${{ steps.versions.outputs.staging-version }}
      semantic-version: ${{ steps.versions.outputs.semantic-version }}
      deployment-risk: ${{ steps.strategy.outputs.deployment-risk }}
      require-approval: ${{ steps.strategy.outputs.require-approval }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¯ Production-Grade Deployment Strategy
        id: strategy
        run: |
          BRANCH="${{ github.ref_name }}"
          REF_TYPE="${{ github.ref_type }}"
          EVENT_NAME="${{ github.event_name }}"
          
          echo "ğŸ¯ INTERMEDIATE PRODUCTION-GRADE DEPLOYMENT DETECTION"
          echo "====================================================="
          echo "ğŸ” Context:"
          echo "  Branch/Tag: $BRANCH"
          echo "  Reference Type: $REF_TYPE"
          echo "  Event: $EVENT_NAME"
          echo "  Actor: ${{ github.actor }}"
          
          # Initialize deployment flags
          DEPLOY_DEV=false
          DEPLOY_STAGING=false
          DEPLOY_PREPROD=false
          DEPLOY_PROD=false
          DEPLOYMENT_RISK="LOW"
          REQUIRE_APPROVAL=false
          
          # Manual deployment with full control
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            echo ""
            echo "ğŸ›ï¸ MANUAL DEPLOYMENT REQUEST"
            TARGET_ENV="${{ github.event.inputs.environment }}"
            echo "  Target Environment: $TARGET_ENV"
            
            case "$TARGET_ENV" in
              "development")
                DEPLOY_DEV=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "staging")
                DEPLOY_STAGING=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "pre-production")
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="MEDIUM"
                REQUIRE_APPROVAL=true
                ;;
              "production")
                DEPLOY_PROD=true
                DEPLOYMENT_RISK="HIGH"
                REQUIRE_APPROVAL=true
                ;;
            esac
            
          # Production deployment: semantic version tags only (v1.2.3)
          elif [[ "$REF_TYPE" == "tag" ]] && [[ "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo ""
            echo "ğŸ­ PRODUCTION RELEASE TAG: $BRANCH"
            
            # Version analysis for risk assessment
            MAJOR=$(echo "$BRANCH" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\1/')
            MINOR=$(echo "$BRANCH" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\2/')
            PATCH=$(echo "$BRANCH" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\3/')
            
            echo "  ğŸ“Š Version Analysis: Major=$MAJOR, Minor=$MINOR, Patch=$PATCH"
            
            # Risk-based deployment strategy
            if [[ "$MAJOR" -gt 0 ]] && [[ "$MINOR" -eq 0 ]] && [[ "$PATCH" -eq 0 ]]; then
              echo "  ğŸš¨ MAJOR RELEASE - Breaking changes expected"
              DEPLOYMENT_RISK="CRITICAL"
              REQUIRE_APPROVAL=true
            elif [[ "$MINOR" -gt 0 ]] && [[ "$PATCH" -eq 0 ]]; then
              echo "  âš ï¸ MINOR RELEASE - New features added"
              DEPLOYMENT_RISK="HIGH"
              REQUIRE_APPROVAL=true
            else
              echo "  ğŸ”§ PATCH RELEASE - Bug fixes and improvements"
              DEPLOYMENT_RISK="MEDIUM"
              REQUIRE_APPROVAL=${{ vars.REQUIRE_PATCH_APPROVAL || 'false' }}
            fi
            
            DEPLOY_PROD=true
            
          # Pre-production deployment: pre-release tags (v1.2.3-pre.*, v1.2.3-rc.*)
          elif [[ "$REF_TYPE" == "tag" ]] && [[ "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-(pre|rc|alpha|beta) ]]; then
            echo ""
            echo "ğŸ¯ PRE-PRODUCTION RELEASE TAG: $BRANCH"
            
            PRERELEASE_TYPE=$(echo "$BRANCH" | sed -E 's/^v[0-9]+\.[0-9]+\.[0-9]+-([^.]+).*$/\1/')
            echo "  ğŸ·ï¸ Pre-release Type: $PRERELEASE_TYPE"
            
            case "$PRERELEASE_TYPE" in
              "rc")
                echo "  ğŸš€ Release Candidate - Production-ready testing"
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="MEDIUM"
                ;;
              "pre")
                echo "  ğŸ§ª Pre-release - Feature validation"
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "alpha"|"beta")
                echo "  ğŸ”¬ Alpha/Beta - Early testing"
                DEPLOY_STAGING=true
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="LOW"
                ;;
            esac
            
          # Branch-based deployments with production-grade logic
          elif [[ "$REF_TYPE" == "branch" ]]; then
            echo ""
            echo "ğŸŒ¿ BRANCH-BASED DEPLOYMENT"
            
            case "$BRANCH" in
              "main"|"master")
                echo "  ğŸŒŸ MAIN BRANCH - Deploy to dev + staging"
                echo "    Production requires release tags for safety"
                DEPLOY_DEV=true
                DEPLOY_STAGING=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "develop"|"development")
                echo "  ğŸ”§ DEVELOP BRANCH - Active development integration"
                DEPLOY_DEV=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "staging")
                echo "  ğŸ§ª STAGING BRANCH - Pre-production testing"
                DEPLOY_STAGING=true
                DEPLOYMENT_RISK="LOW"
                ;;
              "preprod"|"preproduction"|"pre-production")
                echo "  ğŸ¯ PRE-PRODUCTION BRANCH - Release preparation"
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="MEDIUM"
                ;;
              release/*)
                echo "  ğŸš€ RELEASE BRANCH - Release candidate preparation"
                RELEASE_VERSION=$(echo "$BRANCH" | sed 's/release\///')
                echo "    Release Version: $RELEASE_VERSION"
                DEPLOY_STAGING=true
                DEPLOY_PREPROD=true
                DEPLOYMENT_RISK="MEDIUM"
                ;;
              hotfix/*)
                echo "  ğŸ”¥ HOTFIX BRANCH - Critical production fix"
                HOTFIX_VERSION=$(echo "$BRANCH" | sed 's/hotfix\///')
                echo "    Hotfix Version: $HOTFIX_VERSION"
                DEPLOY_DEV=true
                DEPLOY_STAGING=true
                DEPLOYMENT_RISK="HIGH"
                ;;
              feature/*|feat/*)
                echo "  âœ¨ FEATURE BRANCH - New feature development"
                FEATURE_NAME=$(echo "$BRANCH" | sed 's/feature\///' | sed 's/feat\///')
                echo "    Feature: $FEATURE_NAME"
                DEPLOY_DEV=true
                DEPLOYMENT_RISK="LOW"
                ;;
              *)
                echo "  ğŸ” UNKNOWN BRANCH - No automatic deployment"
                ;;
            esac
          fi
          
          # Output deployment decisions
          echo "deploy-dev=$DEPLOY_DEV" >> $GITHUB_OUTPUT
          echo "deploy-staging=$DEPLOY_STAGING" >> $GITHUB_OUTPUT
          echo "deploy-preprod=$DEPLOY_PREPROD" >> $GITHUB_OUTPUT
          echo "deploy-prod=$DEPLOY_PROD" >> $GITHUB_OUTPUT
          echo "deployment-risk=$DEPLOYMENT_RISK" >> $GITHUB_OUTPUT
          echo "require-approval=$REQUIRE_APPROVAL" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ¯ DEPLOYMENT DECISION SUMMARY"
          echo "=============================="
          echo "ğŸ“‹ Target Environments:"
          echo "  ğŸ”§ Development: $DEPLOY_DEV"
          echo "  ğŸ§ª Staging: $DEPLOY_STAGING"
          echo "  ğŸ¯ Pre-Production: $DEPLOY_PREPROD"
          echo "  ğŸ­ Production: $DEPLOY_PROD"
          echo ""
          echo "ğŸ›¡ï¸ Risk & Controls:"
          echo "  ğŸ“Š Risk Level: $DEPLOYMENT_RISK"
          echo "  ğŸ“‹ Approval Required: $REQUIRE_APPROVAL"

      - name: ğŸ·ï¸ Environment-Specific Version Generation
        id: versions
        run: |
          BRANCH="${{ github.ref_name }}"
          REF_TYPE="${{ github.ref_type }}"
          SHORT_SHA=$(echo ${{ github.sha }} | head -c 7)
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          
          echo "ğŸ·ï¸ PRODUCTION-GRADE VERSION GENERATION"
          echo "======================================"
          
          # Development and Staging: Short SHA tags for rapid iteration
          DEV_VERSION="dev-${SHORT_SHA}-${TIMESTAMP}"
          STAGING_VERSION="staging-${SHORT_SHA}-${TIMESTAMP}"
          
          echo "ğŸ“¦ Short SHA Versions (Development/Staging):"
          echo "  Development: $DEV_VERSION"
          echo "  Staging: $STAGING_VERSION"
          
          # Pre-production and Production: Semantic versions
          if [[ "${{ github.event.inputs.force_version }}" != "" ]]; then
            SEMANTIC_VERSION="${{ github.event.inputs.force_version }}"
            echo "ğŸ›ï¸ Manual Version Override: $SEMANTIC_VERSION"
          elif [[ "$REF_TYPE" == "tag" ]]; then
            SEMANTIC_VERSION="$BRANCH"
            echo "ğŸ·ï¸ Tag-based Semantic Version: $SEMANTIC_VERSION"
          else
            # Auto-generate semantic version based on existing tags
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            if [[ "$LAST_TAG" =~ ^v?([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
              MAJOR=${BASH_REMATCH[1]}
              MINOR=${BASH_REMATCH[2]}
              PATCH=${BASH_REMATCH[3]}
              PATCH=$((PATCH + 1))
              SEMANTIC_VERSION="v${MAJOR}.${MINOR}.${PATCH}-dev.${SHORT_SHA}"
            else
              SEMANTIC_VERSION="v1.0.0-dev.${SHORT_SHA}"
            fi
            echo "ğŸ”„ Auto-generated Semantic Version: $SEMANTIC_VERSION"
          fi
          
          echo "dev-version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "staging-version=$STAGING_VERSION" >> $GITHUB_OUTPUT
          echo "semantic-version=$SEMANTIC_VERSION" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“‹ Version Summary:"
          echo "  ğŸ”§ Development: $DEV_VERSION"
          echo "  ğŸ§ª Staging: $STAGING_VERSION"
          echo "  ğŸ¯ Semantic (Pre-prod/Prod): $SEMANTIC_VERSION"

  # Comprehensive build and quality checks using composite actions
  quality-checks:
    name: ğŸ”¨ Build & Quality Checks
    runs-on: ubuntu-latest
    outputs:
      sonar-quality-gate: ${{ steps.sonar-analysis.outputs.quality-gate }}
      sonar-coverage: ${{ steps.sonar-analysis.outputs.coverage }}
      checkmarx-status: ${{ steps.checkmarx-scan.outputs.scan-status }}
      checkmarx-critical: ${{ steps.checkmarx-scan.outputs.critical-count }}
      checkmarx-high: ${{ steps.checkmarx-scan.outputs.high-count }}
      security-scan-status: ${{ steps.security-summary.outputs.status }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests & Build
        run: |
          echo "ğŸ§ª Running comprehensive quality checks..."
          
          # Unit tests with coverage
          npm run test -- --coverage --ci || echo "No tests configured"
          
          # Linting
          npm run lint || echo "No linting configured"
          
          # Build verification
          npm run build || echo "No build configured"
          
          echo "âœ… Basic quality checks completed"

      - name: ğŸ”¬ SonarCloud Analysis
        id: sonar-analysis
        uses: ./.github/actions/sonar-analysis
        with:
          enabled: ${{ env.ENABLE_SONAR }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          min-code-coverage: ${{ env.MIN_CODE_COVERAGE }}
          min-branch-coverage: ${{ vars.MIN_BRANCH_COVERAGE || '70' }}
          sonar-maintainability-rating: ${{ vars.SONAR_MAINTAINABILITY_RATING || 'A' }}
          sonar-reliability-rating: ${{ vars.SONAR_RELIABILITY_RATING || 'A' }}
          sonar-security-rating: ${{ vars.SONAR_SECURITY_RATING || 'A' }}
          max-blocker-issues: ${{ vars.MAX_BLOCKER_ISSUES || '0' }}
          max-critical-issues: ${{ vars.MAX_CRITICAL_ISSUES || '0' }}
          max-major-issues: ${{ vars.MAX_MAJOR_ISSUES || '5' }}
          coverage-exclusions: ${{ vars.SONAR_COVERAGE_EXCLUSIONS || '**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.test.*,**/*.spec.*' }}

      - name: ğŸ”’ Checkmarx Security Scan
        id: checkmarx-scan
        uses: ./.github/actions/checkmarx-scan
        with:
          enabled: ${{ env.ENABLE_CHECKMARX }}
          checkmarx-client: ${{ secrets.CHECKMARX_CLIENT_ID }}
          checkmarx-secret: ${{ secrets.CHECKMARX_SECRET }}
          checkmarx-server: ${{ secrets.CHECKMARX_TENANT || 'your-tenant' }}
          base-uri: ${{ secrets.CHECKMARX_BASE_URI || 'https://ast.checkmarx.net' }}
          scan-types: ${{ vars.CHECKMARX_SCAN_TYPES || 'sca,sast,kics' }}
          max-critical-vulnerabilities: ${{ env.MAX_CRITICAL_VULNERABILITIES }}
          max-high-vulnerabilities: ${{ env.MAX_HIGH_VULNERABILITIES }}
          max-medium-vulnerabilities: ${{ vars.MAX_MEDIUM_VULNERABILITIES || '10' }}
          max-sca-critical: ${{ vars.MAX_SCA_CRITICAL || '0' }}
          max-sca-high: ${{ vars.MAX_SCA_HIGH || '2' }}
          max-kics-high: ${{ vars.MAX_KICS_HIGH || '0' }}
          preset: ${{ vars.CHECKMARX_PRESET || 'Checkmarx Default' }}
          incremental: ${{ vars.CHECKMARX_INCREMENTAL || 'true' }}
          exclude-folders: ${{ vars.CHECKMARX_EXCLUDE_FOLDERS || 'node_modules,dist,build,coverage' }}
          exclude-files: ${{ vars.CHECKMARX_EXCLUDE_FILES || '*.min.js,*.bundle.js' }}

      - name: ğŸ“‹ Security & Quality Summary
        id: security-summary
        run: |
          SONAR_STATUS="${{ steps.sonar-analysis.outputs.scan-status }}"
          CHECKMARX_STATUS="${{ steps.checkmarx-scan.outputs.scan-status }}"
          
          echo "ğŸ“Š Security & Quality Summary:"
          echo "=============================="
          echo "ğŸ”¬ SonarCloud: $SONAR_STATUS"
          echo "ğŸ”’ Checkmarx: $CHECKMARX_STATUS"
          
          # Overall status determination
          if [[ "$SONAR_STATUS" == "FAILED" ]] || [[ "$CHECKMARX_STATUS" == "FAILED" ]]; then
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "âŒ Quality checks failed"
            
            if [[ "$SONAR_STATUS" == "FAILED" ]]; then
              echo "  - SonarCloud quality gate failed"
            fi
            if [[ "$CHECKMARX_STATUS" == "FAILED" ]]; then
              echo "  - Checkmarx security thresholds exceeded"
            fi
          else
            echo "status=PASSED" >> $GITHUB_OUTPUT
            echo "âœ… All quality checks passed"
          fi

  # Development deployment with short SHA versioning
  deploy-dev:
    name: ğŸ”§ Deploy to Development
    runs-on: ubuntu-latest
    needs: [detect-deployment, quality-checks]
    if: needs.detect-deployment.outputs.deploy-dev == 'true'
    environment: development
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build for deployment
        run: |
          npm ci
          npm run build

      - name: Deploy to Development
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "build"

      - name: Development Deployment Success
        run: |
          echo "âœ… Development deployment successful!"
          echo "ğŸ·ï¸ Version: ${{ needs.detect-deployment.outputs.dev-version }}"
          echo "ğŸŒ URL: https://dev-yourapp.azurestaticapps.net"

  # Staging deployment with short SHA versioning
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [detect-deployment, quality-checks]
    if: needs.detect-deployment.outputs.deploy-staging == 'true'
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build for deployment
        run: |
          npm ci
          npm run build

      - name: Deploy to Staging
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "build"

      - name: Staging Deployment Success
        run: |
          echo "âœ… Staging deployment successful!"
          echo "ğŸ·ï¸ Version: ${{ needs.detect-deployment.outputs.staging-version }}"
          echo "ğŸŒ URL: https://staging-yourapp.azurestaticapps.net"

  # Pre-production deployment with semantic versioning
  deploy-preprod:
    name: ğŸ¯ Deploy to Pre-Production
    runs-on: ubuntu-latest
    needs: [detect-deployment, quality-checks]
    if: needs.detect-deployment.outputs.deploy-preprod == 'true'
    environment: pre-production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build for deployment
        run: |
          npm ci
          npm run build

      - name: Deploy to Pre-Production
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PREPROD }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "build"

      - name: Pre-Production Deployment Success
        run: |
          echo "âœ… Pre-production deployment successful!"
          echo "ğŸ·ï¸ Version: ${{ needs.detect-deployment.outputs.semantic-version }}"
          echo "ğŸŒ URL: https://preprod-yourapp.azurestaticapps.net"

  # Production deployment with semantic versioning and enhanced validations
  deploy-prod:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [detect-deployment, quality-checks]
    if: needs.detect-deployment.outputs.deploy-prod == 'true'
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Production Deployment Validation
        run: |
          echo "ğŸ­ PRODUCTION DEPLOYMENT VALIDATION"
          echo "=================================="
          echo "ğŸ·ï¸ Version: ${{ needs.detect-deployment.outputs.semantic-version }}"
          echo "ğŸ“Š Risk Level: ${{ needs.detect-deployment.outputs.deployment-risk }}"
          echo "ğŸ›¡ï¸ Quality Status: ${{ needs.quality-checks.outputs.security-scan-status }}"
          
          # Production-specific validations
          if [[ "${{ needs.quality-checks.outputs.security-scan-status }}" == "FAILED" ]]; then
            echo "âŒ Cannot deploy to production: Quality checks failed"
            exit 1
          fi
          
          echo "âœ… Production deployment validation passed"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build for production
        run: |
          npm ci
          npm run build

      - name: Deploy to Production
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "build"

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.detect-deployment.outputs.semantic-version }}
          release_name: Release ${{ needs.detect-deployment.outputs.semantic-version }}
          body: |
            ğŸš€ Production deployment successful
            
            **Version:** ${{ needs.detect-deployment.outputs.semantic-version }}
            **Risk Level:** ${{ needs.detect-deployment.outputs.deployment-risk }}
            **Quality Gate:** ${{ needs.quality-checks.outputs.sonar-quality-gate || 'N/A' }}
            **Security Status:** ${{ needs.quality-checks.outputs.security-scan-status }}
            
            **Deployment Details:**
            - Commit: ${{ github.sha }}
            - Actor: ${{ github.actor }}
            - URL: https://yourapp.azurestaticapps.net

      - name: Production Deployment Success
        run: |
          echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "=================================="
          echo "ğŸ·ï¸ Version: ${{ needs.detect-deployment.outputs.semantic-version }}"
          echo "ğŸŒ Production URL: https://yourapp.azurestaticapps.net"
          echo "ğŸ“Š Risk Level: ${{ needs.detect-deployment.outputs.deployment-risk }}"

  # Comprehensive deployment summary
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-deployment, quality-checks, deploy-dev, deploy-staging, deploy-preprod, deploy-prod]
    if: always()
    
    steps:
      - name: Comprehensive Deployment Report
        run: |
          echo "ğŸ“Š INTERMEDIATE PRODUCTION-GRADE DEPLOYMENT SUMMARY"
          echo "=================================================="
          echo ""
          echo "ğŸ·ï¸ Version Information:"
          echo "  ğŸ”§ Development: ${{ needs.detect-deployment.outputs.dev-version }}"
          echo "  ğŸ§ª Staging: ${{ needs.detect-deployment.outputs.staging-version }}"
          echo "  ğŸ¯ Semantic (Pre-prod/Prod): ${{ needs.detect-deployment.outputs.semantic-version }}"
          echo ""
          echo "ğŸš€ Deployment Results:"
          echo "  ğŸ”§ Development: ${{ needs.deploy-dev.result || 'skipped' }}"
          echo "  ğŸ§ª Staging: ${{ needs.deploy-staging.result || 'skipped' }}"
          echo "  ğŸ¯ Pre-Production: ${{ needs.deploy-preprod.result || 'skipped' }}"
          echo "  ğŸ­ Production: ${{ needs.deploy-prod.result || 'skipped' }}"
          echo ""
          echo "ğŸ›¡ï¸ Quality & Security:"
          echo "  ğŸ“Š Quality Checks: ${{ needs.quality-checks.result }}"
          echo "  ğŸ”¬ SonarCloud Gate: ${{ needs.quality-checks.outputs.sonar-quality-gate || 'skipped' }}"
          echo "  ğŸ“ˆ Code Coverage: ${{ needs.quality-checks.outputs.sonar-coverage || 'N/A' }}%"
          echo "  ğŸ”’ Checkmarx Status: ${{ needs.quality-checks.outputs.checkmarx-status || 'skipped' }}"
          echo "  ğŸš¨ Critical Vulns: ${{ needs.quality-checks.outputs.checkmarx-critical || '0' }}"
          echo "  âš ï¸ High Vulns: ${{ needs.quality-checks.outputs.checkmarx-high || '0' }}"
          echo "  ğŸ›¡ï¸ Overall Status: ${{ needs.quality-checks.outputs.security-scan-status || 'skipped' }}"
          echo ""
          echo "ğŸ“‹ Risk Assessment:"
          echo "  ğŸ“Š Deployment Risk: ${{ needs.detect-deployment.outputs.deployment-risk }}"
          echo "  ğŸ“‹ Approval Required: ${{ needs.detect-deployment.outputs.require-approval }}"